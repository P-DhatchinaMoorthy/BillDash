<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice {{ invoice_number }}</title>
  <style>
    @page { size: A4; margin: 0; }
    @media print {
      @page { margin: 0; }
      body { margin: 0; background: white !important; }
      .invoice-box { margin: 0; border: none; width: 100%; min-height: 100vh; padding: 15mm; }
      .page-break { page-break-before: always; }
      .no-print { display: none !important; }
      .page-header { display: block; }
    }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 0; background: #f5f5f5; }
    .invoice-box { width: 210mm; min-height: 297mm; margin: 16px auto; padding: 20px; background: white; }
    @media print {
      .invoice-box { height: auto; }
      .page-break-content { page-break-before: always; }
    }
    .center { text-align: center; }
    .right { text-align: right; }
    .left { text-align: left; }
    .bold { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #000; }
    th, td { padding: 5px; font-size: 12px; }
    th { background-color: #f5f5f5; font-weight: bold; text-align: center; }
    td { text-align: center; }
    .item-cell { text-align: left; }
    .bank-terms-table td { text-align: left !important; }
    .calc-table .right-align { text-align: right !important; }
    .calc-table td { text-align: center; }
    .calc-table th { text-align: center; }
    .calc-table .center-align { text-align: center !important; }
    .no-border { border: none; }
    .header-table td { border: none; padding: 10px; }
    .signature-box { height: 100px; border: 1px dashed #000; text-align: center; vertical-align: middle; margin-top: 20px; }
    .amount-section { background-color: #f9f9f9; }
    .total-row { background-color: #e9e9e9; font-weight: bold; }
    small { font-size: 10px; color: #666; }
    .status-paid { color: green; font-weight: bold; }
    .status-partial { color: orange; font-weight: bold; }
    .status-pending { color: red; font-weight: bold; }
    .brand-name { font-size: 18px; font-weight: bold; text-align: center; color: #2c3e50; letter-spacing: 1px; }
    .brand-slogan { font-size: 11px;text-align-last: center; color: #7f8c8d; margin-top: 2px; }
    .header-box { border: 1px solid #000; display: flex; }
    .company-section { width: 50%; padding: 15px; display: flex; align-items: flex-end; }
    .logo-area { width: 120px; margin-right: 15px; }
    .company-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; }
    .invoice-section { width: 50%; border-left: 1px solid #000; display: flex; align-items: flex-end; justify-content: flex-end; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="invoice-box">

  <!-- Download and Send Mail Buttons -->
  <div class="no-print" style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
    <button onclick="downloadPDF()" style="background-color: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; margin-right: 10px;">
      ðŸ“„ Download PDF
    </button>
    <button onclick="sendMail()" style="background-color: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
      ðŸ“§ Send Mail
    </button>
  </div>

  <div class="header-box">
    <div class="company-section">
      <div class="logo-area">
        {% if logo_base64 %}
        <img src="data:image/jpeg;base64,{{ logo_base64 }}" alt="Company Logo" style="width:100px; height:80px; object-fit: contain;">
        {% else %}
        <img src="/addons/DMlogo.jpg" alt="Company Logo" style="width:100px; height:80px; object-fit: contain;">
        {% endif %}
              </div>
      <div class="company-info" style="text-align: left; margin-left: 70px">
        <div style="font-size: 12px;">
        </div>
        <p style="margin-top: 10px; font-size: 11px;">
            <b>GSTIN {{ company_settings.gst_number or 'Error' }}</b><br>
        {{ company_settings.registered_address or 'Error' }}<br>
            {{ company_settings.state or 'Error' }}, {{ company_settings.postal_code or 'Error' }}
            {% if company_settings.website %}{{ company_settings.website }}{% endif %}
            Ph: {{ company_settings.primary_phone or 'Error' }}<br>
        </p>
      </div>
    </div>
    <div class="invoice-section">
      <table style="margin: 0px; border-collapse: collapse; border-top: 1px solid #000;" >
        <tr >
          <td style="border: 1px solid #000; padding: 8px; width: 50%;"><strong>Invoice #:</strong><br>{{ invoice.invoice_number }}</td>
          <td style="border: 1px solid #000; padding: 8px; width: 50%;"><strong>Invoice Date:</strong><br>{{ invoice.invoice_date[:10] }}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #000; padding: 8px;"><strong>Invoice ID:</strong><br>{{ invoice.id }}</td>
          <td style="border: 1px solid #000; padding: 8px;"><strong>Due Date:</strong><br>{{ invoice.due_date[:10] if invoice.due_date else invoice.invoice_date[:10] }}</td>
        </tr>
      </table>
    </div>
  </div>

  <table style="width: 753px;">
    <tr>
      <td class="item-cell" style="width: 327px">
        <b>{{ customer.id }}</b>, <b>{{ customer.contact_person }}</b><br>
        <b>Billing address:</b>{{ customer.billing_address or 'Address not provided' }}<br>
        <b>Ph: </b>{{ customer.phone }}
        {% if customer.email %}<br><b>Email: </b>{{ customer.email }}{% endif %}
      </td>
      <td class="item-cell" style="width: 326px">
        <b>Shipping address:</b>
        {{ customer.shipping_address or customer.billing_address or 'Address not provided' }}<br>
        <b>Branch:</b> {{ customer.branch or 'Not specified' }}
      </td>
    </tr>
  </table>

  <table>
    <tr>
      <th>S.No</th><th>Product ID</th><th class="item-cell">Item</th><th>HSN/SAC</th><th>Tax</th><th>Qty</th><th>Rate/Item</th><th>Per</th><th>Amount</th>
    </tr>
    {% for item in items %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ item.product_id }}</td>
      <td class="item-cell">{{ item.product_name }}<br><small>SKU: {{ item.sku }}</small>
      {% if item.description %}<br><small>{{ item.description }}</small>{% endif %}
      {% if item.batch_number %}<br><small>Batch: {{ item.batch_number }}</small>{% endif %}
      {% if item.expiry_date %}<br><small>Exp: {{ item.expiry_date[:10] }}</small>{% endif %}</td>
      <td>{{ item.hsn_code or 'N/A' }}</td>
      <td>{{ (item.tax_rate_per_item|float)|round(1) }}%</td>
      <td>{{ item.quantity }}</td>
      <td>â‚¹{{ item.unit_price }}</td>
      <td>{{ item.unit_of_measure or 'NOS' }}</td>
      <td>â‚¹{{ item.total_price }}</td>
    </tr>
    {% endfor %}
  </table>

    <div style="display: flex; gap: 10px;">
        <table class="bank-terms-table calc-table" style="width: 75%;">
    <tr>
      <th>HSN/SAC</th><th>Product Value</th><th>CGST %</th><th>CGST</th><th>SGST%</th><th>SGST</th><th>Total Tax Amount</th>
    </tr>
    {% set hsn_summary = {} %}
    {% for item in items %}
      {% set hsn = item.hsn_code or 'N/A' %}
      {% set tax_rate = item.tax_rate_per_item|float %}
      {% set taxable_value = (item.total_price|float) - ((item.total_price|float * tax_rate) / (100 + tax_rate)) %}
      {% set cgst_rate = tax_rate / 2 %}
      {% set sgst_rate = tax_rate / 2 %}
      {% set cgst_amount = (taxable_value * cgst_rate / 100)|round(2) %}
      {% set sgst_amount = (taxable_value * sgst_rate / 100)|round(2) %}
      {% set total_tax = cgst_amount + sgst_amount %}

      {% if hsn in hsn_summary %}
        {% set _ = hsn_summary[hsn].update({
          'taxable_value': hsn_summary[hsn]['taxable_value'] + taxable_value,
          'cgst_amount': hsn_summary[hsn]['cgst_amount'] + cgst_amount,
          'sgst_amount': hsn_summary[hsn]['sgst_amount'] + sgst_amount,
          'total_tax': hsn_summary[hsn]['total_tax'] + total_tax
        }) %}
      {% else %}
        {% set _ = hsn_summary.update({hsn: {
          'taxable_value': taxable_value,
          'cgst_rate': cgst_rate,
          'sgst_rate': sgst_rate,
          'cgst_amount': cgst_amount,
          'sgst_amount': sgst_amount,
          'total_tax': total_tax
        }}) %}
      {% endif %}
    {% endfor %}

    {% for hsn, data in hsn_summary.items() %}
    <tr>
      <td class="center-align">{{ hsn }}</td>
      <td class="right-align">{{ "%.2f"|format(data.taxable_value) }}</td>
      <td class="center-align">{{ "%.2f"|format(data.cgst_rate) }}%</td>
      <td class="right-align">{{ "%.2f"|format(data.cgst_amount) }}</td>
      <td class="center-align">{{ "%.2f"|format(data.sgst_rate) }}%</td>
      <td class="right-align">{{ "%.2f"|format(data.sgst_amount) }}</td>
      <td class="right-align">{{ "%.2f"|format(data.total_tax) }}</td>
    </tr>
    {% endfor %}
    <tr class="total-row">
      <td class="bold center-align">Total</td>
      <td class="bold right-align">{{ "%.2f"|format(calculations.subtotal|float) }}</td>
      <td class="center-align"></td>
      <td class="bold right-align">{{ "%.2f"|format(invoice.tax_amount|float / 2) }}</td>
      <td class="center-align"></td>
      <td class="bold right-align">{{ "%.2f"|format(invoice.tax_amount|float / 2) }}</td>
      <td class="bold right-align">{{ "%.2f"|format(calculations.tax_amount|float) }}</td>
    </tr>
  </table>


    <table style="width: 30%; border: 1px solid #000; margin-left: auto;">
    <!-- Subtotal Row -->
    <tr>
      <td colspan="8" style="width: 126px" class="right bold">Taxable Amount</td>
      <td class="bold" style="width: 86px">â‚¹{{ "%.2f"|format(calculations.subtotal|float) }}</td>
    </tr>
    
    <!-- CGST Row -->
    {% set total_tax = invoice.tax_amount|float %}
    {% if total_tax > 0 %}
    <tr>
      <td colspan="8" class="right">CGST 9.0%</td>
      <td style="display: flex; justify-content: end; border: 0px">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
    </tr>
    
    <!-- SGST Row -->
    <tr>
      <td colspan="8" class="right">SGST 9.0%</td>
      <td style="display: flex; justify-content: end; border: 0px">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
    </tr>
    {% endif %}
    
    <!-- Discount Row -->
    {% if invoice.discount_amount and invoice.discount_amount != '0.00' %}
    <tr>
      <td colspan="8" class="right">Discount</td>
      <td style="display: flex; justify-content: end; border: 0px">-â‚¹{{ "%.2f"|format(invoice.discount_amount|float) }}</td>
    </tr>
    {% endif %}
    
    <!-- Shipping Charges Row -->
    {% if invoice.shipping_charges and invoice.shipping_charges != '0.00' %}
    <tr>
      <td colspan="8" class="right">Shipping Charges</td>
      <td style="display: flex; justify-content: end; border: 0px">â‚¹{{ "%.2f"|format(invoice.shipping_charges|float) }}</td>
    </tr>
    {% endif %}
    
    <!-- Other Charges Row -->
    {% if invoice.other_charges and invoice.other_charges != '0.00' %}
    <tr>
      <td colspan="8" class="right">Other Charges</td>
      <td style="display: flex; justify-content: end; border: 0px">â‚¹{{ "%.2f"|format(invoice.other_charges|float) }}</td>
    </tr>
    {% endif %}
    
    <!-- Grand Total Row -->
    <tr class="total-row">
      <td colspan="8" class="bold right"> Grand Total</td>
<!--      <td class="bold">{{ items|sum(attribute='quantity') }} </td>-->
      <td class="bold">â‚¹{{ calculations.grand_total }} </td>
    </tr>
  </table>

</div>

  <p><b>Amount Chargeable (in words):</b> INR {{ amount_in_words or 'Amount in words not available' }}.</p>

<div class="page-break"></div>


<div class="amount-section">
  {% if payments %}
  <!-- Payment Details + Status aligned side by side -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">

    <!-- Left Side: Payment Details -->
    <div style="flex: 1;">
      <p class="bold">Payment Details:</p>
      {% for payment in payments %}
      <p>
        â€¢ Amount Paid â‚¹{{ payment.amount_paid }} via {{ payment.payment_method }}
        on {{ payment.payment_date[:10] }}
        {% if payment.transaction_reference %} - Ref: {{ payment.transaction_reference }}{% endif %}
        {% if payment.discount_amount and payment.discount_amount != '0.00' %}
          (Discount: â‚¹{{ payment.discount_amount }})
        {% endif %}
      </p>
      {% endfor %}

      <!-- Summary -->
      <p class="bold">
        Total Paid: â‚¹{{ summary.total_amount_paid }} | Balance Due: â‚¹{{ summary.balance_due }}
      </p>

      {% if summary.total_excess_amount and summary.total_excess_amount != '0.00' %}
      <p class="bold" style="color: blue;">
        Excess Amount: â‚¹{{ summary.total_excess_amount }}
      </p>
      {% endif %}
    </div>

    <!-- Right Side: Big Status -->
    <div style="display: flex; align-items: center; justify-content: center; min-width: 200px; margin-right: 60px">
      <h2 style="font-size: 20px; font-weight: bold; margin: 0; color: black; text-align: right;">
          PAYMENT : <b class="{% if invoice.status == 'Paid' %}status-paid{% elif invoice.status == 'Pending' %}status-pending{% elif invoice.status == 'Cancelled' %}status-cancelled{% endif %}">{{ invoice.status|upper }}</b></p>
      </h2>
    </div>
  </div>

  {% else %}
  <!-- If no payments exist -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <p class="bold">Payment Status: {{ summary.payment_status }} | Balance Due: â‚¹{{ summary.balance_due }}</p>
  </div>
  {% endif %}
</div>

  <table class="item-cell" style="width:100%; border-collapse: collapse;">
  <tr>
    <td style="text-align: left; vertical-align: top; padding: 5px;">
      <b>Bank Details:</b><br>
      {% if payments and payments[0].bank_details %}
      {{ payments[0].bank_details }}
      {% else %}
      Bank: Your Bank Name<br>
      Account #: Your Account Number<br>
      IFSC: Your IFSC Code<br>
      Branch: Your Branch
      {% endif %}
    </td>
    <td style="text-align: left; vertical-align: top; padding: 5px;">
      <b>Terms and Conditions:</b><br>
      1. Goods once sold cannot be taken back or exchanged.<br>
      2. We are not the manufacturers, company will stand for warranty as per their terms and conditions.<br>
      3. Interest @24% p.a. will be charged for uncleared bills beyond 15 days.<br>
      4. Subject to local Jurisdiction.<br>
      {% if customer.payment_terms %}5. Payment Terms: {{ customer.payment_terms }}<br>{% endif %}
      {% if invoice.payment_terms %}6. Invoice Payment Terms: {{ invoice.payment_terms }}{% endif %}
    </td>
  </tr>
</table>


  <p class="center">This is a digitally signed document.<br>
  Generated on: {{ generated_at or 'N/A' }}<br>
  <small>Invoice ID: {{ invoice_id }} | Currency: {{ currency or 'INR' }}
  {% if invoice.updated_at %} | Last Updated: {{ invoice.updated_at[:10] }}{% endif %}</small></p>



  <script>
    function downloadPDF() {
      try {
        const invoiceBox = document.querySelector('.invoice-box');
        const invoiceId = '{{ invoice_id }}';
        
        html2canvas(invoiceBox, {
          scale: 1.5,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          const imgData = canvas.toDataURL('image/png');
          const imgWidth = 210;
          const pageHeight = 297;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          pdf.save(`invoice_${invoiceId}.pdf`);
        }).catch(err => {
          console.error('Canvas error:', err);
          alert('PDF generation failed. Check console for details.');
        });
      } catch (err) {
        console.error('PDF error:', err);
        alert('PDF generation failed. Check console for details.');
      }
    }

    function sendMail() {
      const invoiceId = '{{ invoice_id or invoice.id }}';
      const customerEmail = '{{ customer.email or "" }}';
      
      console.log('Debug - Invoice ID:', invoiceId);
      console.log('Debug - Customer Email:', customerEmail);
      
      if (!invoiceId || invoiceId === '') {
        alert('Invoice ID not found!');
        return;
      }
      
      if (!customerEmail || customerEmail === '') {
        const email = prompt('Enter customer email address:');
        if (!email) {
          alert('Email is required to send invoice!');
          return;
        }
        customerEmail = email;
      }
      
      if (confirm(`Send invoice to ${customerEmail}?`)) {
        const requestData = {
          invoice_id: invoiceId,
          customer_email: customerEmail
        };
        
        console.log('Sending request:', requestData);
        
        fetch('/send-invoice-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            alert('Invoice sent successfully!');
          } else {
            alert('Failed to send invoice: ' + data.error);
            if (data.debug_info) {
              console.log('Debug info:', data.debug_info);
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to send invoice: ' + error.message);
        });
      }
    }
  </script>

</div>
</body>
</html>
