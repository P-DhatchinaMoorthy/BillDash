<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice {{ invoice.invoice_number }}</title>
  <style>
    @page { 
      size: A4; 
      margin: 18mm 12mm 22mm 12mm;
      @top-center { content: element(page-header); }
      @bottom-center { content: element(page-footer); }
    }
    @media print {
      body { margin: 0; background: white !important; }
      .no-print { display: none !important; }
      .page-header { position: running(page-header); }
      .page-footer { position: running(page-footer); }
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; margin: 0; padding: 0; background: #f2f3f7; }
    .invoice-box { width: 210mm; margin: 28px auto 12px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 28px #dde3ec; overflow: hidden; padding: 0; }
    .block-ribbon { 
      height: 36px; 
      background: linear-gradient(90deg,#c7538e 0%, #46b6ac 100%);
      color: #fff; 
      font-size: 19px; 
      letter-spacing: 1.5px;
      font-weight: bold;
      display: flex; 
      align-items: center;
      justify-content: flex-start;
      padding-left: 20px;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 2px 16px 0 #f8e0ee44;
    }
    .page-header { margin: 0 0 22px 0; padding: 0 36px; }
    .header-box { display: flex; width: 100%; padding-top: 20px; }
    .info-block {
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      justify-content: flex-end; 
      padding-bottom: 10px;
    }
    .info-details {
      text-align: left;
      font-size: 12px;
      color: #763769;
      line-height: 1.6;
    }
    .invoice-section { 
      min-width: 220px; 
      border-left: 4px solid #e7d3e2; 
      margin-left: 15px;
      border-radius: 0 10px 0 0;
      background: #faf7fa;
      padding-left: 18px;
      display: flex; 
      flex-direction: column;
      justify-content: flex-end;
    }
    .invoice-section table { width: 100%; }
    .invoice-section td { border: none; padding: 4px 8px 2px 3px; font-size: 12px; font-weight: 500; }
    .brand-logo { width: 60px; height: 60px; border-radius: 7px; margin-bottom: 7px; background: #fff0fb; }
    .brand-logo img { width: 50px; height: 50px; object-fit: contain; border-radius: 6px; padding: 3px; background: #fff; }
    .brand-name { font-size: 16px; font-weight: bold; color: #c7538e; margin-bottom: 1px; }
    .brand-slogan { color: #73818c; font-size: 10px; margin-bottom: 4px; }
    .customer-table td { border: none; font-size:12px; }
    .main-content { min-height: 500px; padding: 0 36px; }
    .center { text-align: center; }
    .right { text-align: right; }
    .left { text-align: left; }
    .bold { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #eddff3; }
    th, td { padding: 6px 7px; font-size: 12px; }
    th { background: #f9f4fc; font-weight: bold; text-align: center; }
    td { text-align: center; }
    .item-cell { text-align: left; }
    .signature-box { height: 40px; border: 1px dashed #d486bc; text-align: center; vertical-align: middle; margin-top: 14px; }
    .amount-section { background: #faf7fa; }
    .total-row { background: #f0dde9; font-weight: bold; }
    small { font-size: 10px; color: #c7538e; }
    .status-paid { color: #26a857; font-weight: bold; }
    .status-partial { color: #ceaf0a; font-weight: bold; }
    .status-pending { color: #f25d5d; font-weight: bold; }
    .page-footer { margin: 32px 0 0 0; padding: 0 36px 14px 36px; }
  </style>
</head>
<body>
<div class="invoice-box">
   <!-- Download and Send Mail Buttons -->
  <div class="no-print" style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
    <button onclick="downloadPDF()" style="background-color: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; margin-right: 10px;">
      ðŸ“„ Download PDF
    </button>
    <button onclick="sendMail()" style="background-color: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
      ðŸ“§ Send Mail
    </button>
  </div>
  <div class="block-ribbon">
    INVOICE
  </div>
  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-box">
      <div class="info-block">
        <div class="brand-logo">
          {% if logo_base64 %}
          <img src="data:image/jpeg;base64,{{ logo_base64 }}" alt="Company Logo">
          {% else %}
          <img src="/addons/DMlogo.jpg" alt="Company Logo">
          {% endif %}
        </div>
        <div class="brand-name">{{ company_settings.brand_name or 'Brand Name' }}</div>
        <div class="brand-slogan">{{ company_settings.brand_slogan or 'Brand Slogan' }}</div>
        <div class="info-details">
          <b>GSTIN {{ company_settings.gst_number or 'Error' }}</b><br>
          {{ company_settings.registered_address or 'Error' }}<br>
          {{ company_settings.state or 'Error' }}, {{ company_settings.postal_code or 'Error' }}
          {% if company_settings.website %}<br>{{ company_settings.website }}{% endif %}<br>
          Ph: {{ company_settings.primary_phone or 'Error' }}
        </div>
      </div>
      <div class="invoice-section">
        <table>
          <tr>
            <td><strong>Invoice Number:</strong><br>{{ invoice.invoice_number }}</td>
            <td><strong>Invoice Id:</strong><br>{{ invoice.id }}</td>
          </tr>
          <tr>
            <td><strong>Invoice Date:</strong><br>{{ invoice.invoice_date[:10] }}</td>
            <td><strong>Due Date:</strong><br>{{ invoice.due_date[:10] if invoice.due_date else invoice.invoice_date[:10] }}</td>
          </tr>
        </table>
      </div>
    </div>
    <table style="width: 100%; margin-top:12px;" class="customer-table">
      <tr>
        <td class="item-cell" style="width: 50%">
          <b>{{ customer.id }}</b>, <b>{{ customer.contact_person }}</b><br>
          <b>Billing address:</b>{{ customer.billing_address or 'Address not provided' }}<br>
          <b>Ph: </b>{{ customer.phone }}
          {% if customer.email %}<br><b>Email: </b>{{ customer.email }}{% endif %}
        </td>
        <td class="item-cell" style="width: 50%">
          <b>Shipping address:</b>
          {{ customer.shipping_address or customer.billing_address or 'Address not provided' }}<br>
          <b>Branch:</b> {{ customer.branch or 'Not specified' }}
        </td>
      </tr>
    </table>
  </div>
  <!-- MAIN CONTENT -->
  <div class="main-content">
    <table>
      <tr>
        <th>S.No</th><th class="item-cell">Product Name</th><th>Tax</th><th>Qty</th><th>Rate/Item</th><th>Amount</th>
      </tr>
      {% for item in items %}
      <tr>
        <td>{{ loop.index }}</td>
        <td class="item-cell">{{ item.product_name }}</td>
        <td>{{ (item.tax_rate_per_item|float)|round(1) }}%</td>
        <td>{{ item.quantity }}</td>
        <td>â‚¹{{ item.unit_price }}</td>
        <td>â‚¹{{ item.total_price }}</td>
      </tr>
      {% endfor %}
    </table>
    <div style="width: 100%; display: flex;">
      <div class="amount-section" style="width: 70%">
        <p><b>Amount Chargeable (in words):</b><br> INR {{ amount_in_words or 'Amount in words not available' }}.</p>
        {% if payments %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <div style="flex: 1;">
            <p class="bold">Payment Details:</p>
            {% for payment in payments %}
            <p>
              â€¢ Amount Paid â‚¹{{ payment.amount_paid }} via {{ payment.payment_method }} <br>â€¢ {{ payment.payment_date[:10] }}
              {% if payment.transaction_reference %} - Ref: {{ payment.transaction_reference }}{% endif %}
              {% if payment.discount_amount and payment.discount_amount != '0.00' %}
                (Discount: â‚¹{{ payment.discount_amount }})
              {% endif %}
            </p>
            {% endfor %}
            <p class="bold">
              Total Paid: â‚¹{{ summary.total_amount_paid }} | Balance Due: â‚¹{{ summary.balance_due }}
            </p>
            {% if summary.total_excess_amount and summary.total_excess_amount != '0.00' %}
            <p class="bold" style="color: blue;">
              Excess Amount: â‚¹{{ summary.total_excess_amount }}
            </p>
            {% endif %}
          </div>
          <div style="display: flex; align-items: center; justify-content: center; min-width: 200px; margin-right: 45px; margin-bottom: 30px">
            <h2 style="font-size: 20px; font-weight: bold; margin: 0; color: black; text-align: right;">
              PAYMENT : <span class="{% if invoice.status == 'Paid' %}status-paid{% elif invoice.status == 'Pending' %}status-pending{% elif invoice.status == 'Cancelled' %}status-cancelled{% endif %}">{{ invoice.status|upper }}</span>
            </h2>
          </div>
        </div>
        {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <p class="bold">Payment Status: {{ summary.payment_status }} | Balance Due: â‚¹{{ summary.balance_due }}</p>
        </div>
        {% endif %}
      </div>
      <table style="width: 30%; border: 1px solid #eddff3; margin-left: auto;">
        <tr>
          <td colspan="8" style="width: 124px" class="right bold">Taxable Amount</td>
          <td class="bold" style="width: 86px">â‚¹{{ "%.2f"|format(calculations.subtotal|float) }}</td>
        </tr>
        {% set total_tax = invoice.tax_amount|float %}
        {% if total_tax > 0 %}
        <tr>
          <td colspan="8" class="right">CGST 9.0%</td>
          <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
        </tr>
        <tr>
          <td colspan="8" class="right">SGST 9.0%</td>
          <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
        </tr>
        {% endif %}
        {% if invoice.discount_amount and invoice.discount_amount != '0.00' %}
        <tr>
          <td colspan="8" class="right">Discount</td>
          <td class="right">-â‚¹{{ "%.2f"|format(invoice.discount_amount|float) }}</td>
        </tr>
        {% endif %}
        {% if invoice.shipping_charges and invoice.shipping_charges != '0.00' %}
        <tr>
          <td colspan="8" class="right">Shipping Charges</td>
          <td class="right">â‚¹{{ "%.2f"|format(invoice.shipping_charges|float) }}</td>
        </tr>
        {% endif %}
        {% if invoice.other_charges and invoice.other_charges != '0.00' %}
        <tr>
          <td colspan="8" class="right">Other Charges</td>
          <td class="right">â‚¹{{ "%.2f"|format(invoice.other_charges|float) }}</td>
        </tr>
        {% endif %}
        <tr class="total-row">
          <td colspan="8" class="bold right">Grand Total</td>
          <td class="bold">â‚¹{{ calculations.grand_total }}</td>
        </tr>
      </table>
    </div>
  </div>
  <!-- PAGE FOOTER -->
  <div class="page-footer">
    <table class="item-cell" style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="text-align: left; vertical-align: top; padding: 5px;">
          <b>Bank Details:</b><br>
          {% if payments and payments[0].bank_details %}
          {{ payments[0].bank_details }}
          {% else %}
          Bank Name: {{ company_settings.bank_name }}<br>
          Account : {{ company_settings.account_number }}<br>
          IFSC: {{ company_settings.ifsc_code }}<br>
          Branch: {{ company_settings.branch }}
          {% endif %}
        </td>
        <td style="text-align: left; vertical-align: top; padding: 5px;">
          <b>Terms and Conditions:</b><br>
          1. Goods once sold cannot be taken back or exchanged.<br>
          2. We are not the manufacturers, company will stand for warranty as per their terms and conditions.<br>
          3. Interest @24% p.a. will be charged for uncleared bills beyond 15 days.<br>
          4. Subject to local Jurisdiction.<br>
          {% if customer.payment_terms %}5. Payment Terms: {{ customer.payment_terms }}<br>{% endif %}
          {% if invoice.payment_terms %}6. Invoice Payment Terms: {{ invoice.payment_terms }}{% endif %}
        </td>
      </tr>
    </table>
    <p class="center">This is a digitally signed document.<br>
    Generated on: {{ generated_at or 'N/A' }}<br>
    <small>Invoice ID: {{ invoice_id }} | Currency: {{ currency or 'INR' }}
    {% if invoice.updated_at %} | Last Updated: {{ invoice.updated_at[:10] }}{% endif %}</small></p>
  </div>
</div>
<script>
function downloadPDF() {
  window.print();
}

function sendMail() {
  const invoiceId = '{{ invoice.id }}';
  const customerEmail = '{{ customer.email }}';
  
  if (!customerEmail) {
    alert('Customer email not available');
    return;
  }
  
  if (confirm(`Send invoice to ${customerEmail}?`)) {
    fetch('/send-invoice-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        invoice_id: invoiceId,
        email: customerEmail
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Invoice sent successfully!');
      } else {
        alert('Failed to send invoice: ' + data.message);
      }
    })
    .catch(error => {
      alert('Error sending invoice: ' + error.message);
    });
  }
}
</script>
</body>
</html>