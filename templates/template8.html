<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice {{ invoice.invoice_number }}</title>
  <style>
    @page { size: A4; margin: 18mm 12mm 20mm 12mm;}
    @media print {
      body { margin: 0; background: #fff !important; }
      .no-print { display: none !important; }
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fb;}
    .invoice-box { width: 210mm; margin: 26px auto; background: #fff; border-radius: 12px; box-shadow: 0 0 24px #d0d7e5; border: 1px solid #dee4ef; }
    .header-flat {
      border-bottom: 2px solid #204169;
      border-radius: 12px 12px 0 0;
      padding: 32px 36px 12px 36px;
      background: #f8fafc;
      display: flex; 
      align-items: flex-end;
      min-height: 82px;
    }
    .brand-logo img { width: 65px; height: 65px; border-radius: 9px; background: #fff; box-shadow: 0 0 6px #e8eaef;}
    .brand-info { margin-left: 24px;padding-bottom:8px;}
    .brand-name { font-size: 20px; color: #204169; font-weight: bold;}
    .brand-slogan { color: #6783a6; font-size: 11px;}
    .header-details { color: #425a71; font-size: 12px; }
    .invoice-section { margin-left: auto; min-width: 285px; background: #f5f6fa; border: 1px solid #dee4ef; border-radius: 7px; padding: 12px;}
    .invoice-section table { width: 100%;}
    .invoice-section td { border: none; font-size: 12px; padding: 4px 3px;}
    .clearfix { clear: both;}
    .main-content { padding:0 36px;}
    table { width: 100%; border-collapse: collapse; margin-top: 14px;}
    table, th, td { border: 1.2px solid #b7c4dc;}
    th { background: #f0f3f9; color: #204169; font-weight: bold;}
    td,th { font-size: 12px; text-align: center; padding: 7px;}
    .item-cell { text-align: left;}
    .amount-section { background: #f6f8fb;}
    .total-row { background: #e1e7ee; color: #204169; font-weight: bold;}
    small { font-size: 10px; color: #7a90a6;}
    .status-paid { color: #28a075; font-weight: bold;}
    .status-pending { color: #c24646; font-weight: bold;}
    .status-partial { color: #9a890e; font-weight: bold;}
    .page-footer { margin-top: 32px; padding: 0 36px 16px 36px;}
  </style>
</head>
<body>
<div class="invoice-box">
  <!-- Download and Send Mail Buttons -->
  <div class="no-print" style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
    <button onclick="downloadPDF()" style="background-color: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; margin-right: 10px;">
      ðŸ“„ Download PDF
    </button>
    <button onclick="sendMail()" style="background-color: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
      ðŸ“§ Send Mail
    </button>
  </div>
  <div class="header-flat">
    <div class="brand-logo">
      {% if logo_base64 %}
      <img src="data:image/jpeg;base64,{{ logo_base64 }}" alt="Company Logo">
      {% else %}
      <img src="/addons/DMlogo.jpg" alt="Company Logo">
      {% endif %}
    </div>
    <div class="brand-info">
      <div class="brand-name">{{ company_settings.brand_name or 'Brand Name' }}</div>
      <div class="brand-slogan">{{ company_settings.brand_slogan or 'Brand Slogan' }}</div>
      <div class="header-details">
        <b>GSTIN {{ company_settings.gst_number or 'Error' }}</b><br>
        {{ company_settings.registered_address or 'Error' }}<br>
        {{ company_settings.state or 'Error' }}, {{ company_settings.postal_code or 'Error' }}
        {% if company_settings.website %}<br>{{ company_settings.website }}{% endif %}<br>
        Ph: {{ company_settings.primary_phone or 'Error' }}
      </div>
    </div>
    <div class="invoice-section">
      <table>
        <tr>
          <td><strong>Invoice Number:</strong><br>{{ invoice.invoice_number }}</td>
          <td><strong>Invoice Id:</strong><br>{{ invoice.id }}</td>
        </tr>
        <tr>
          <td><strong>Invoice Date:</strong><br>{{ invoice.invoice_date[:10] }}</td>
          <td><strong>Due Date:</strong><br>{{ invoice.due_date[:10] if invoice.due_date else invoice.invoice_date[:10] }}</td>
        </tr>
      </table>
    </div>
  </div>
  <div class="main-content">
    <table>
      <tr>
        <th>S.No</th><th class="item-cell">Product Name</th><th>Tax</th><th>Qty</th><th>Rate/Item</th><th>Amount</th>
      </tr>
      {% for item in items %}
      <tr>
        <td>{{ loop.index }}</td>
        <td class="item-cell">{{ item.product_name }}</td>
        <td>{{ (item.tax_rate_per_item|float)|round(1) }}%</td>
        <td>{{ item.quantity }}</td>
        <td>â‚¹{{ item.unit_price }}</td>
        <td>â‚¹{{ item.total_price }}</td>
      </tr>
      {% endfor %}
    </table>
    <div style="width: 100%; display: flex;">
      <div class="amount-section" style="width: 70%">
        <p><b>Amount Chargeable (in words):</b><br> INR {{ amount_in_words or 'Amount in words not available' }}.</p>
        {% if payments %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <div style="flex: 1;">
            <p class="bold">Payment Details:</p>
            {% for payment in payments %}
            <p>
              â€¢ Amount Paid â‚¹{{ payment.amount_paid }} via {{ payment.payment_method }} <br>â€¢ {{ payment.payment_date[:10] }}
              {% if payment.transaction_reference %} - Ref: {{ payment.transaction_reference }}{% endif %}
              {% if payment.discount_amount and payment.discount_amount != '0.00' %}
                (Discount: â‚¹{{ payment.discount_amount }})
              {% endif %}
            </p>
            {% endfor %}
            <p class="bold">
              Total Paid: â‚¹{{ summary.total_amount_paid }} | Balance Due: â‚¹{{ summary.balance_due }}
            </p>
            {% if summary.total_excess_amount and summary.total_excess_amount != '0.00' %}
            <p class="bold" style="color: blue;">
              Excess Amount: â‚¹{{ summary.total_excess_amount }}
            </p>
            {% endif %}
          </div>
          <div style="display: flex; align-items: center; justify-content: center; min-width: 200px; margin-right: 45px; margin-bottom: 30px">
            <h2 style="font-size: 20px; font-weight: bold; margin: 0; color: black; text-align: right;">
              PAYMENT : <span class="{% if invoice.status == 'Paid' %}status-paid{% elif invoice.status == 'Pending' %}status-pending{% elif invoice.status == 'Cancelled' %}status-cancelled{% endif %}">{{ invoice.status|upper }}</span>
            </h2>
          </div>
        </div>
        {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <p class="bold">Payment Status: {{ summary.payment_status }} | Balance Due: â‚¹{{ summary.balance_due }}</p>
        </div>
        {% endif %}
      </div>
      <table style="width: 30%; border: 1.2px solid #b7c4dc; margin-left: auto;">
        <tr>
          <td colspan="8" class="right bold">Taxable Amount</td>
          <td class="bold">â‚¹{{ "%.2f"|format(calculations.subtotal|float) }}</td>
        </tr>
        {% set total_tax = invoice.tax_amount|float %}
        {% if total_tax > 0 %}
        <tr>
          <td colspan="8" class="right">CGST 9.0%</td>
          <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
        </tr>
        <tr>
          <td colspan="8" class="right">SGST 9.0%</td>
          <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
        </tr>
        {% endif %}
        {% if invoice.discount_amount and invoice.discount_amount != '0.00' %}
        <tr>
          <td colspan="8" class="right">Discount</td>
          <td class="right">-â‚¹{{ "%.2f"|format(invoice.discount_amount|float) }}</td>
        </tr>
        {% endif %}
        {% if invoice.shipping_charges and invoice.shipping_charges != '0.00' %}
        <tr>
          <td colspan="8" class="right">Shipping Charges</td>
          <td class="right">â‚¹{{ "%.2f"|format(invoice.shipping_charges|float) }}</td>
        </tr>
        {% endif %}
        {% if invoice.other_charges and invoice.other_charges != '0.00' %}
        <tr>
          <td colspan="8" class="right">Other Charges</td>
          <td class="right">â‚¹{{ "%.2f"|format(invoice.other_charges|float) }}</td>
        </tr>
        {% endif %}
        <tr class="total-row">
          <td colspan="8" class="bold right">Grand Total</td>
          <td class="bold">â‚¹{{ calculations.grand_total }}</td>
        </tr>
      </table>
    </div>
    <div class="page-footer">
      <table class="item-cell" style="width:100%; border-collapse: collapse;">
        <tr>
          <td style="text-align: left; vertical-align: top; padding: 5px;">
            <b>Bank Details:</b><br>
            {% if payments and payments[0].bank_details %}
            {{ payments[0].bank_details }}
            {% else %}
            Bank Name: {{ company_settings.bank_name }}<br>
            Account : {{ company_settings.account_number }}<br>
            IFSC: {{ company_settings.ifsc_code }}<br>
            Branch: {{ company_settings.branch }}
            {% endif %}
          </td>
          <td style="text-align: left; vertical-align: top; padding: 5px;">
            <b>Terms and Conditions:</b><br>
            1. Goods once sold cannot be taken back or exchanged.<br>
            2. We are not the manufacturers, company will stand for warranty as per their terms and conditions.<br>
            3. Interest @24% p.a. will be charged for uncleared bills beyond 15 days.<br>
            4. Subject to local Jurisdiction.<br>
            {% if customer.payment_terms %}5. Payment Terms: {{ customer.payment_terms }}<br>{% endif %}
            {% if invoice.payment_terms %}6. Invoice Payment Terms: {{ invoice.payment_terms }}{% endif %}
          </td>
        </tr>
      </table>
      <p class="center">This is a digitally signed document.<br>
      Generated on: {{ generated_at or 'N/A' }}<br>
      <small>Invoice ID: {{ invoice_id }} | Currency: {{ currency or 'INR' }}
      {% if invoice.updated_at %} | Last Updated: {{ invoice.updated_at[:10] }}{% endif %}</small></p>
    </div>
  </div>
</div>
<script>
function downloadPDF() {
  window.print();
}

function sendMail() {
  const invoiceId = '{{ invoice.id }}';
  const customerEmail = '{{ customer.email }}';
  
  if (!customerEmail) {
    alert('Customer email not available');
    return;
  }
  
  if (confirm(`Send invoice to ${customerEmail}?`)) {
    fetch('/send-invoice-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        invoice_id: invoiceId,
        email: customerEmail
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Invoice sent successfully!');
      } else {
        alert('Failed to send invoice: ' + data.message);
      }
    })
    .catch(error => {
      alert('Error sending invoice: ' + error.message);
    });
  }
}
</script>
</body>
</html>