<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice {{ invoice.invoice_number }}</title>
  <style>
    @page {
      size: A4;
      margin: 20mm 15mm 25mm 15mm;
      @top-center { content: element(page-header); }
      @bottom-center { content: element(page-footer); }
    }
    @media print {
      body { margin: 0; background: white !important; }
      .no-print { display: none !important; }
      .page-header { position: running(page-header); }
      .page-footer { position: running(page-footer); }
    }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 0; background: #f8f2e6; }
    .invoice-box { width: 210mm; margin: 20px auto; padding: 22px; background: white; box-shadow: 0 4px 24px #eae0b2; }
    .accent-bar { background: linear-gradient(90deg,#ffd452 60%,#fec163 100%); height: 30px; border-radius: 8px 8px 0 0; margin-bottom: 4px; }
    .page-header { margin-bottom: 20px; }
    .page-footer { margin-top: 20px; }
    .main-content { min-height: 500px; }
    .center { text-align: center; }
    .right { text-align: right; }
    .left { text-align: left; }
    .bold { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #d1c27b; }
    th, td { padding: 5px; font-size: 12px; }
    th { background: #fffbe7; font-weight: bold; text-align: center; }
    td { text-align: center; }
    .item-cell { text-align: left; }
    .calc-table .right-align { text-align: right !important; }
    .calc-table td { text-align: center; }
    .calc-table th { text-align: center; }
    .calc-table .center-align { text-align: center !important; }
    .no-border { border: none; }
    .header-table td { border: none; padding: 10px; }
    .signature-box { height: 40px; border: 1px dashed #c09b43; text-align: center; vertical-align: middle; margin-top: 12px; }
    .amount-section { background: #fffbe7; }
    .total-row { background: #ffe999; font-weight: bold; }
    small { font-size: 10px; color: #b89f25; }
    .status-paid { color: green; font-weight: bold; }
    .status-partial { color: orange; font-weight: bold; }
    .status-pending { color: red; font-weight: bold; }
    .brand-name { font-size: 18px; font-weight: bold; text-align: center; color: #c59e1e; letter-spacing: 1px; }
    .brand-slogan { font-size: 11px; text-align: center; color: #ece3c3; margin-top: 2px; }
    .header-box { display: flex; }
    .company-section { width: 58%; padding: 14px; display: flex; align-items: flex-end; }
    .logo-area { width: 120px; margin-right: 18px; }
    .company-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; }
    .invoice-section { width: 42%; border-left: 1px solid #c5b16d; display: flex; align-items: flex-end; justify-content: flex-end; }
  </style>
</head>
<body>
<div class="invoice-box">
  <!-- Download and Send Mail Buttons -->
  <div class="no-print" style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
    <button onclick="downloadPDF()" style="background-color: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; margin-right: 10px;">
      ðŸ“„ Download PDF
    </button>
    <button onclick="sendMail()" style="background-color: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
      ðŸ“§ Send Mail
    </button>
  </div>
  <div class="accent-bar"></div>
  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-box">
      <div class="company-section" style="border: 1px solid #c5b16d; border-right: none">
        <div class="logo-area">
          {% if logo_base64 %}
          <img src="data:image/jpeg;base64,{{ logo_base64 }}" alt="Company Logo" style="width:100px; height:80px; object-fit: contain;">
          {% else %}
          <img src="/addons/DMlogo.jpg" alt="Company Logo" style="width:100px; height:80px; object-fit: contain;">
          {% endif %}
        </div>
        <div class="company-info" style="text-align: left; margin-left: 70px">
          <p style="margin-top: 10px; font-size: 12px; margin-bottom: 10px; margin-left: -70px; line-height: 1.2;">
            <b>GSTIN {{ company_settings.gst_number or 'Error' }}</b><br>
            {{ company_settings.registered_address or 'Error' }}<br>
            {{ company_settings.state or 'Error' }}, {{ company_settings.postal_code or 'Error' }}
            {% if company_settings.website %}<br>{{ company_settings.website }}{% endif %}<br>
            Ph: {{ company_settings.primary_phone or 'Error' }}
          </p>
        </div>
      </div>
      <div class="invoice-section" style="padding: 0; border: none">
        <table style="width: 100%; height: 100%;">
          <tr>
            <td style="padding: 8px; width: 50%;"><strong>Invoice Number:</strong><br>{{ invoice.invoice_number }}</td>
            <td style="padding: 8px; width: 50%;"><strong>Invoice Id:</strong><br>{{ invoice.id }}</td>
          </tr>
          <tr>
            <td style="padding: 8px; width: 50%;"><strong>Invoice Date:</strong><br>{{ invoice.invoice_date[:10] }}</td>
            <td style="padding: 8px;"><strong>Due Date:</strong><br>{{ invoice.due_date[:10] if invoice.due_date else invoice.invoice_date[:10] }}</td>
          </tr>
        </table>
      </div>
    </div>
    <table style="width: 758px; margin-top:16px;">
      <tr>
        <td class="item-cell" style="width: 328px">
          <b>{{ customer.id }}</b>, <b>{{ customer.contact_person }}</b><br>
          <b>Billing address:</b>{{ customer.billing_address or 'Address not provided' }}<br>
          <b>Ph: </b>{{ customer.phone }}
          {% if customer.email %}<br><b>Email: </b>{{ customer.email }}{% endif %}
        </td>
        <td class="item-cell" style="width: 328px">
          <b>Shipping address:</b>
          {{ customer.shipping_address or customer.billing_address or 'Address not provided' }}<br>
          <b>Branch:</b> {{ customer.branch or 'Not specified' }}
        </td>
      </tr>
    </table>
  </div>
  <!-- MAIN CONTENT -->
  <div class="main-content">
  <table>
    <tr>
      <th>S.No</th><th class="item-cell">Product Name</th><th>Tax</th><th>Qty</th><th>Rate/Item</th><th>Amount</th>
    </tr>
    {% for item in items %}
    <tr>
      <td>{{ loop.index }}</td>
      <td class="item-cell">{{ item.product_name }}</td>
      <td>{{ (item.tax_rate_per_item|float)|round(1) }}%</td>
      <td>{{ item.quantity }}</td>
      <td>â‚¹{{ item.unit_price }}</td>
      <td>â‚¹{{ item.total_price }}</td>
    </tr>
    {% endfor %}
  </table>
<div style="width: 100%; display: flex;">
<div class="amount-section" style="width: 70%">
  <p><b>Amount Chargeable (in words):</b><br> INR {{ amount_in_words or 'Amount in words not available' }}.</p>
  {% if payments %}
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <div style="flex: 1;">
      <p class="bold">Payment Details:</p>
      {% for payment in payments %}
      <p>
        â€¢ Amount Paid â‚¹{{ payment.amount_paid }} via {{ payment.payment_method }} <br>â€¢ {{ payment.payment_date[:10] }}
        {% if payment.transaction_reference %} - Ref: {{ payment.transaction_reference }}{% endif %}
        {% if payment.discount_amount and payment.discount_amount != '0.00' %}
          (Discount: â‚¹{{ payment.discount_amount }})
        {% endif %}
      </p>
      {% endfor %}
      <p class="bold">
        Total Paid: â‚¹{{ summary.total_amount_paid }} | Balance Due: â‚¹{{ summary.balance_due }}
      </p>
      {% if summary.total_excess_amount and summary.total_excess_amount != '0.00' %}
      <p class="bold" style="color: blue;">
        Excess Amount: â‚¹{{ summary.total_excess_amount }}
      </p>
      {% endif %}
    </div>
    <div style="display: flex; align-items: center; justify-content: center; min-width: 200px; margin-right: 45px; margin-bottom: 30px">
      <h2 style="font-size: 20px; font-weight: bold; margin: 0; color: black; text-align: right;">
        PAYMENT : <span class="{% if invoice.status == 'Paid' %}status-paid{% elif invoice.status == 'Pending' %}status-pending{% elif invoice.status == 'Cancelled' %}status-cancelled{% endif %}">{{ invoice.status|upper }}</span>
      </h2>
    </div>
  </div>
  {% else %}
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <p class="bold">Payment Status: {{ summary.payment_status }} | Balance Due: â‚¹{{ summary.balance_due }}</p>
  </div>
  {% endif %}
</div>
    <table style="width: 30%; border: 1px solid #c5b16d; margin-left: auto;">
    <tr>
      <td colspan="8" style="width: 124px" class="right bold">Taxable Amount</td>
      <td class="bold" style="width: 86px">â‚¹{{ "%.2f"|format(calculations.subtotal|float) }}</td>
    </tr>
    {% set total_tax = invoice.tax_amount|float %}
    {% if total_tax > 0 %}
    <tr>
      <td colspan="8" class="right">CGST 9.0%</td>
      <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
    </tr>
    <tr>
      <td colspan="8" class="right">SGST 9.0%</td>
      <td class="right">â‚¹{{ "%.2f"|format(total_tax / 2) }}</td>
    </tr>
    {% endif %}
    {% if invoice.discount_amount and invoice.discount_amount != '0.00' %}
    <tr>
      <td colspan="8" class="right">Discount</td>
      <td class="right">-â‚¹{{ "%.2f"|format(invoice.discount_amount|float) }}</td>
    </tr>
    {% endif %}
    {% if invoice.shipping_charges and invoice.shipping_charges != '0.00' %}
    <tr>
      <td colspan="8" class="right">Shipping Charges</td>
      <td class="right">â‚¹{{ "%.2f"|format(invoice.shipping_charges|float) }}</td>
    </tr>
    {% endif %}
    {% if invoice.other_charges and invoice.other_charges != '0.00' %}
    <tr>
      <td colspan="8" class="right">Other Charges</td>
      <td class="right">â‚¹{{ "%.2f"|format(invoice.other_charges|float) }}</td>
    </tr>
    {% endif %}
    <tr class="total-row">
      <td colspan="8" class="bold right">Grand Total</td>
      <td class="bold">â‚¹{{ calculations.grand_total }}</td>
    </tr>
  </table>
</div>
<div class="page-footer">
  <table class="item-cell" style="width:100%; border-collapse: collapse;">
  <tr>
    <td style="text-align: left; vertical-align: top; padding: 5px;">
      <b>Bank Details:</b><br>
      {% if payments and payments[0].bank_details %}
      {{ payments[0].bank_details }}
      {% else %}
      Bank Name: {{ company_settings.bank_name }}<br>
      Account : {{ company_settings.account_number }}<br>
      IFSC: {{ company_settings.ifsc_code }}<br>
      Branch: {{ company_settings.branch }}
      {% endif %}
    </td>
    <td style="text-align: left; vertical-align: top; padding: 5px;">
      <b>Terms and Conditions:</b><br>
      1. Goods once sold cannot be taken back or exchanged.<br>
      2. We are not the manufacturers, company will stand for warranty as per their terms and conditions.<br>
      3. Interest @24% p.a. will be charged for uncleared bills beyond 15 days.<br>
      4. Subject to local Jurisdiction.<br>
      {% if customer.payment_terms %}5. Payment Terms: {{ customer.payment_terms }}<br>{% endif %}
      {% if invoice.payment_terms %}6. Invoice Payment Terms: {{ invoice.payment_terms }}{% endif %}
    </td>
  </tr>
</table>
  <p class="center">This is a digitally signed document.<br>
  Generated on: {{ generated_at or 'N/A' }}<br>
  <small>Invoice ID: {{ invoice_id }} | Currency: {{ currency or 'INR' }}
  {% if invoice.updated_at %} | Last Updated: {{ invoice.updated_at[:10] }}{% endif %}</small></p>
</div>
</div>
</div>
</body>
</html>


  <script>
    function downloadPDF() {
      try {
        const invoiceBox = document.querySelector('.invoice-box');
        const invoiceId = '{{ invoice_id }}';

        html2canvas(invoiceBox, {
          scale: 1.5,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');

          const imgData = canvas.toDataURL('image/png');
          const imgWidth = 210;
          const pageHeight = 297;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          pdf.save(`invoice_${invoiceId}.pdf`);
        }).catch(err => {
          console.error('Canvas error:', err);
          alert('PDF generation failed. Check console for details.');
        });
      } catch (err) {
        console.error('PDF error:', err);
        alert('PDF generation failed. Check console for details.');
      }
    }

    function sendMail() {
      const invoiceId = '{{ invoice_id or invoice.id }}';
      let customerEmail = '{{ customer.email or "" }}';

      console.log('Debug - Invoice ID:', invoiceId);
      console.log('Debug - Customer Email:', customerEmail);

      if (!invoiceId || invoiceId === '') {
        alert('Invoice ID not found!');
        return;
      }

      if (!customerEmail || customerEmail === '') {
        const email = prompt('Enter customer email address:');
        if (!email) {
          alert('Email is required to send invoice!');
          return;
        }
        customerEmail = email;
      }

      if (confirm(`Send invoice to ${customerEmail}?`)) {
        const requestData = {
          invoice_id: invoiceId,
          customer_email: customerEmail
        };

        console.log('Sending request:', requestData);

        fetch('/send-invoice-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            alert('Invoice sent successfully!');
          } else {
            alert('Failed to send invoice: ' + data.error);
            if (data.debug_info) {
              console.log('Debug info:', data.debug_info);
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to send invoice: ' + error.message);
        });
      }
    }
  </script>

<script>
function downloadPDF() {
  window.print();
}

function sendMail() {
  const invoiceId = '{{ invoice.id }}';
  const customerEmail = '{{ customer.email }}';

  if (!customerEmail) {
    alert('Customer email not available');
    return;
  }

  if (confirm(`Send invoice to ${customerEmail}?`)) {
    fetch('/send-invoice-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        invoice_id: invoiceId,
        email: customerEmail
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Invoice sent successfully!');
      } else {
        alert('Failed to send invoice: ' + data.message);
      }
    })
    .catch(error => {
      alert('Error sending invoice: ' + error.message);
    });
  }
}
</script>
